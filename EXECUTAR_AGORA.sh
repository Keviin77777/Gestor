#!/bin/bash

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ๐ SCRIPT DE CORREรรO COMPLETA DA API
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# 
# Este script executa TODAS as correรงรตes necessรกrias:
# 1. Atualiza cรณdigo do GitHub
# 2. Corrige permissรตes e storage
# 3. Corrige configuraรงรฃo do Nginx
# 4. Testa a API
#
# Execute: bash EXECUTAR_AGORA.sh
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐ CORREรรO COMPLETA DA API - UltraGestor"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

# Verificar se estรก no diretรณrio correto
if [ ! -f "fix-api-production.sh" ]; then
    echo "โ Erro: Execute este script no diretรณrio do projeto"
    echo "   cd /www/wwwroot/ultragestor.site/Gestor"
    exit 1
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PASSO 1: Atualizar cรณdigo do GitHub
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo "๐ฅ PASSO 1: Atualizando cรณdigo do GitHub..."
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

git pull origin main

if [ $? -eq 0 ]; then
    echo ""
    echo "โ Cรณdigo atualizado com sucesso!"
else
    echo ""
    echo "โ๏ธ  Erro ao atualizar cรณdigo. Continuando mesmo assim..."
fi

echo ""
echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PASSO 2: Corrigir permissรตes e storage
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐ PASSO 2: Corrigindo permissรตes e storage..."
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

bash fix-api-production.sh

echo ""
echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PASSO 3: Corrigir configuraรงรฃo do Nginx
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐ PASSO 3: Corrigindo configuraรงรฃo do Nginx..."
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

bash fix-nginx-config.sh

echo ""
echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PASSO 4: Teste final
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐งช PASSO 4: Teste final da API..."
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

sleep 3

echo "Teste 1: GET /api/"
API_TEST=$(curl -s https://ultragestor.site/api/)
echo "$API_TEST"
echo ""

if echo "$API_TEST" | grep -q "online"; then
    echo "โ API estรก online!"
    API_OK=true
else
    echo "โ API nรฃo estรก respondendo corretamente"
    API_OK=false
fi

echo ""
echo "Teste 2: POST /api/auth (login)"
LOGIN_TEST=$(curl -s -X POST https://ultragestor.site/api/auth \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@admin.com","password":"admin123","action":"login"}')

# Mostrar apenas primeiros 200 caracteres
echo "${LOGIN_TEST:0:200}..."
echo ""

if echo "$LOGIN_TEST" | grep -q "token"; then
    echo "โ Login funcionando!"
    LOGIN_OK=true
elif echo "$LOGIN_TEST" | grep -q "error"; then
    echo "โ๏ธ  API respondeu com erro (mas estรก funcionando)"
    LOGIN_OK=true
else
    echo "โ Login nรฃo estรก funcionando"
    LOGIN_OK=false
fi

echo ""
echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# RESUMO FINAL
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐ RESUMO FINAL"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

if [ "$API_OK" = true ] && [ "$LOGIN_OK" = true ]; then
    echo "๐ SUCESSO! API estรก funcionando perfeitamente!"
    echo ""
    echo "โ Cรณdigo atualizado"
    echo "โ Permissรตes corrigidas"
    echo "โ Storage criado"
    echo "โ Nginx configurado"
    echo "โ API respondendo"
    echo "โ Login funcionando"
    echo ""
    echo "๐ Acesse: https://ultragestor.site"
    echo ""
    echo "๐ Prรณximos passos:"
    echo "   1. Testar login no frontend"
    echo "   2. Verificar PM2: pm2 list"
    echo "   3. Testar criaรงรฃo de clientes"
    echo "   4. Configurar Evolution API (WhatsApp)"
else
    echo "โ๏ธ  ATENรรO: Alguns problemas foram encontrados"
    echo ""
    
    if [ "$API_OK" = false ]; then
        echo "โ API nรฃo estรก respondendo"
        echo "   Verifique os logs:"
        echo "   tail -f /www/wwwlogs/ultragestor.site.error.log"
    fi
    
    if [ "$LOGIN_OK" = false ]; then
        echo "โ Login nรฃo estรก funcionando"
        echo "   Verifique o banco de dados:"
        echo "   mysql -u ultragestor_db -p ultragestor_db"
    fi
    
    echo ""
    echo "๐ Documentaรงรฃo:"
    echo "   - PROBLEMA_403_NGINX.md"
    echo "   - COMANDOS_CORRIGIR_API.md"
    echo "   - SOLUCAO_RAPIDA_API.md"
fi

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""
